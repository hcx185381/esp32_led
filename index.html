<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESP32 æ—¶å°šæ§åˆ¶å°</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            min-height: 100vh;
            background: linear-gradient(145deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 35px 25px;
            width: 100%;
            max-width: 420px;
            color: white;
            transition: all 0.3s ease;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px;
            background: linear-gradient(to right, #fff, #a8ede0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .status-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 100px;
            padding: 20px 25px;
            margin: 25px 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .status-label {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
        }
        .status-value {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-value::before {
            content: "";
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 14px;
            background-color: #f44336;
            box-shadow: 0 0 8px #f44336;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .status-value.on::before {
            background-color: #4CAF50;
            box-shadow: 0 0 12px #4CAF50;
        }
        .connection-badge {
            font-size: 0.9rem;
            text-align: center;
            margin: 10px 0 25px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.25);
            border-radius: 40px;
            display: inline-block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
            backdrop-filter: blur(4px);
        }
        .button-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .btn {
            flex: 1 1 130px;
            padding: 18px 10px;
            border: none;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
        }
        .btn:hover {
            transform: translateY(-4px);
            filter: brightness(1.1);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-on {
            background: linear-gradient(145deg, #2e7d32, #4CAF50);
        }
        .btn-off {
            background: linear-gradient(145deg, #b71c1c, #f44336);
        }
        .btn-music {
            background: linear-gradient(145deg, #bf360c, #FF9800);
        }
        .footer-note {
            margin-top: 30px;
            font-size: 0.8rem;
            opacity: 0.5;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 18px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ESP32 æ™ºèƒ½æ§åˆ¶</h1>

        <div class="status-container">
            <span class="status-label">LED çŠ¶æ€</span>
            <span class="status-value" id="ledStatus">å…³é—­</span>
        </div>

        <div class="connection-badge" id="connectionStatus">
            â³ è¿æ¥ä¸­...
        </div>

        <div class="button-grid">
            <button class="btn btn-on" id="btnOn">ğŸ”† æ‰“å¼€ LED</button>
            <button class="btn btn-off" id="btnOff">âŒ å…³é—­ LED</button>
            <button class="btn btn-music" id="btnMusic">ğŸµ æ’­æ”¾éŸ³ä¹</button>
        </div>

        <div class="footer-note">
            âœ¨ å®æ—¶æ§åˆ¶ Â· è¿œç¨‹éŸ³ä¹
        </div>
    </div>

    <script>
        // MQTT é…ç½®
        // åŸæ¥çš„å…¬å…±åœ°å€
        // const brokerUrl = 'wss://broker-cn.emqx.io:8084/mqtt';

        // æ”¹æˆä½ ç”µè„‘çš„IPå’Œ EMQX çš„ WebSocket ç«¯å£ (8083æ˜¯éåŠ å¯†ï¼Œ8084æ˜¯åŠ å¯†)
        // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨éåŠ å¯†çš„ 8083 ç«¯å£
        const brokerUrl = 'wss://192.168.0.111:8084/mqtt'; // âš ï¸ æ›¿æ¢æˆä½ çš„IP
        const options = {
            clean: true,
            connectTimeout: 4000,
            clientId: 'web_' + Math.random().toString(16).substr(2, 8),
            username: 'esp32user',       // æ·»åŠ ç”¨æˆ·å
            password: 'hcx185381'        // æ·»åŠ å¯†ç 
        };
        const controlTopic = 'esp32/led/control';
        const statusTopic = 'esp32/led/status';

        const client = mqtt.connect(brokerUrl, options);
        const ledStatusSpan = document.getElementById('ledStatus');
        const connStatusP = document.getElementById('connectionStatus');

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–° LED æŒ‡ç¤ºå™¨æ ·å¼
        function updateLedUI(value) {
            const isOn = (value === '1');
            ledStatusSpan.innerText = isOn ? 'å¼€å¯' : 'å…³é—­';
            if (isOn) {
                ledStatusSpan.classList.add('on');
            } else {
                ledStatusSpan.classList.remove('on');
            }
        }

        client.on('connect', function () {
            console.log('MQTT è¿æ¥æˆåŠŸ');
            connStatusP.innerText = 'âœ… å·²è¿æ¥';
            client.subscribe(statusTopic, function (err) {
                if (!err) {
                    console.log('å·²è®¢é˜…çŠ¶æ€ä¸»é¢˜');
                } else {
                    console.error('è®¢é˜…å¤±è´¥', err);
                }
            });
        });

        client.on('message', function (topic, message) {
            // â˜… å…³é”®è°ƒè¯•è¾“å‡ºï¼šåœ¨æ§åˆ¶å°èƒ½çœ‹åˆ°æ”¶åˆ°çš„åŸå§‹æ¶ˆæ¯
            console.log('æ”¶åˆ°æ¶ˆæ¯, ä¸»é¢˜:', topic, 'å†…å®¹:', message.toString());
            if (topic === statusTopic) {
                const value = message.toString();
                updateLedUI(value);
            }
        });

        client.on('error', function (err) {
            console.error('MQTT é”™è¯¯:', err);
            connStatusP.innerText = 'âŒ è¿æ¥é”™è¯¯';
        });

        client.on('close', function () {
            console.log('MQTT è¿æ¥å…³é—­');
            connStatusP.innerText = 'âš ï¸ æ–­å¼€è¿æ¥';
        });

        document.getElementById('btnOn').addEventListener('click', function () {
            console.log('å‘é€å¼€ç¯æŒ‡ä»¤');
            client.publish(controlTopic, '1');
        });

        document.getElementById('btnOff').addEventListener('click', function () {
            console.log('å‘é€å…³ç¯æŒ‡ä»¤');
            client.publish(controlTopic, '2');
        });

        document.getElementById('btnMusic').addEventListener('click', function () {
            console.log('å‘é€æ’­æ”¾éŸ³ä¹æŒ‡ä»¤');
            client.publish(controlTopic, '3');
        });
    </script>
</body>
</html>
